<!DOCTYPE html>
<html>
<head>
    {% if config.WTF_CSRF_ENABLED -%}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {%- endif %}
    <title>{{ title }}</title>
    {% include 'swagger-ui-css.html' %}
    {% include 'swagger-ui-libs.html' %}
    <script type="text/javascript">
        $(function () {
            {% if config.WTF_CSRF_ENABLED -%}
                // get CSRF token from meta tag
                var csrftoken = $('meta[name=csrf-token]').attr('content');

                // whenever we send a AJAX POST request, we add the X-CSRFToken for it
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });
            {%- endif %}

            window.swaggerUi = new SwaggerUi({
                url: "{{ specs_url }}",
                validatorUrl: "{{ config.SWAGGER_VALIDATOR_URL }}" || null,
                dom_id: "swagger-ui-container",
                supportedSubmitMethods: ['get', 'post', 'put', 'delete', 'patch'],
                authorizations: {
                    {% if config.WTF_CSRF_ENABLED -%}
                        csrfInterceptor: function() {
                        // This function will get called /before/ each request
                        // ... UNLESS you have a 'security' tag in the swagger.json file,
                        // ... in which case you must add 'csrfInterceptor' to the list of auths.
                        var csrftoken = $('meta[name=csrf-token]').attr('content')
                        this.headers['X-CSRFToken'] = csrftoken;
                        return true;
                        // there is a bug, fixed but not in develop_2.0 of swagger-ui.js where returning true will only
                        //   process _one_ interceptor This works if it's your only interceptor and
                        //   when the fix is in, it'll work as expected for more than one...
                        }
                    {%- endif %}
                },
                onComplete: function(swaggerApi, swaggerUi){
                    if(typeof initOAuth == "function") {
                        {% if config.SWAGGER_UI_OAUTH_CLIENT_ID -%}
                            initOAuth({
                                clientId: "{{ config.SWAGGER_UI_OAUTH_CLIENT_ID }}",
                                realm: "{{ config.SWAGGER_UI_OAUTH_REALM }}",
                                appName: "{{ config.SWAGGER_UI_OAUTH_APP_NAME }}"
                            });
                        {%- endif %}
                    }
                    $('pre code').each(function(i, e) {
                        hljs.highlightBlock(e)
                    });

                    {% if config.JWT_AUTH_URL_RULE -%}
                         //console.log($('#swagger-ui-container')[0].outerHTML);
                        $(document).find('div.response_headers').bind('DOMSubtreeModified', function(event) {
                            var response = JSON.parse($(this).text());
                            var tokenField = 'jwt-token';
                            if (response.hasOwnProperty(tokenField)) {
                                var jwt_token = response[tokenField];
                                swaggerUi.api.clientAuthorizations.add("key", new SwaggerClient.ApiKeyAuthorization("Authorization", "JWT " + jwt_token, "header"));
                            }
                        });
                    {%- endif %}
                },
                onFailure: function(data) {
                    log("Unable to Load SwaggerUI");
                },
                jsonEditor: {{ config.SWAGGER_UI_JSONEDITOR | default(False) | string | lower }},
                docExpansion: "{{ config.SWAGGER_UI_DOC_EXPANSION | default('none') }}"
            });
            window.swaggerUi.load();
        });
    </script>
</head>

<body class="swagger-section">
    <div id="message-bar" class="swagger-ui-wrap">&nbsp;</div>
    <div id="swagger-ui-container" class="swagger-ui-wrap"></div>
</body>
</html>
